// js/auth.js (simple version)
// ---------------------------
// Exposes: getSupabase, requireAuth, signIn, signOut,
// loginWithDiscord, getSession, currentUsername, goto, getBasePath

/***** CONFIG *****/
const SUPABASE_URL = "https://fcegavhipeaeihxegsnw.supabase.co";
const SUPABASE_ANON_KEY = "YOUR_PUBLIC_ANON_KEY_HERE"; // <-- replace with your anon key

/***** BASE PATH (GitHub Pages friendly) *****/
function getBasePath() {
  try {
    const parts = location.pathname.split("/").filter(Boolean);
    const onGithub = /\.github\.io$/.test(location.hostname);
    if (onGithub && parts.length) return "/" + parts[0] + "/";
  } catch {}
  return "/";
}
const BASE = getBasePath();
window.getBasePath = getBasePath;

/***** SUPABASE CLIENT *****/
if (!window.supabase) {
  console.error(
    '[auth] Supabase JS not loaded. Add <script src="https://unpkg.com/@supabase/supabase-js@2"></script> BEFORE js/auth.js'
  );
}

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: {
    persistSession: true,
    detectSessionInUrl: true,  // Supabase handles ?code=... for us
    flowType: "pkce",
    autoRefreshToken: true,
  },
});

window.getSupabase = () => sb;

/***** HELPERS *****/
window.goto = function goto(path = "") {
  const isAbs = /^\//.test(path);
  location.href = isAbs ? path : BASE + path;
};

window.getSession = async function getSession() {
  const { data } = await sb.auth.getSession();
  return data?.session ?? null;
};

window.currentUsername = function currentUsername(session) {
  const email = session?.user?.email || "";
  return email.split("@")[0] || "";
};

/***** PROTECT PAGES *****/
window.requireAuth = async function requireAuth() {
  try {
    const { data: { session } } = await sb.auth.getSession();
    if (!session) {
      goto("auth.html");
      return null;
    }
    return session;
  } catch (e) {
    console.error("[auth] requireAuth failed:", e);
    goto("auth.html");
    return null;
  }
};

/***** USERNAME/PASSWORD LOGIN *****/
window.signIn = async function signIn(usernameOrEmail, password) {
  const email = usernameOrEmail.includes("@")
    ? usernameOrEmail
    : `${usernameOrEmail}@jmbn.local`;

  const { data, error } = await sb.auth.signInWithPassword({ email, password });
  return { data, error };
};

window.signOut = async function signOut() {
  try {
    await sb.auth.signOut();
  } finally {
    goto("auth.html");
  }
};

/***** DISCORD LINK SYNC (auto /link) *****/
async function syncDiscordLink(session) {
  if (!session || !session.user) return;

  const user = session.user;
  const meta = user.user_metadata || {};

  // Try a couple of common fields for Discord ID
  const discordId =
    meta.provider_id ||  // often used
    meta.sub ||          // sometimes used
    meta.id ||           // fallback
    null;

  if (!discordId) {
    console.log("[auth] No discordId in metadata; skipping discord_links sync.");
    return;
  }

  const handle =
    meta.global_name ||
    meta.username ||
    meta.full_name ||
    (user.email ? user.email.split("@")[0] : null);

  const row = {
    discord_id: String(discordId),
    user_id: user.id,
    handle,
  };

  const { error } = await sb.from("discord_links").upsert(row);
  if (error) {
    console.error("[auth] upsert discord_links failed:", error);
  } else {
    console.log("[auth] discord_links synced:", row);
  }
}

/***** DISCORD OAUTH LOGIN *****/
window.loginWithDiscord = async function loginWithDiscord() {
  const redirectTo = `${location.origin}${BASE}auth.html`;

  const { error } = await sb.auth.signInWithOAuth({
    provider: "discord",
    options: {
      redirectTo,
      scopes: "identify email",
    },
  });

  if (error) {
    console.error("[auth] Discord OAuth error:", error);
    throw error;
  }
};

/***** WHENEVER AUTH STATE CHANGES *****/
sb.auth.onAuthStateChange(async (event, session) => {
  // When user finishes Discord login, Supabase will:
  // 1) create the session
  // 2) fire SIGNED_IN here
  if (event === "SIGNED_IN") {
    const provider = session?.user?.app_metadata?.provider;
    if (provider === "discord") {
      await syncDiscordLink(session);  // auto-link to discord_links
    }
  }
});